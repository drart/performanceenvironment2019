<html>
    <head>
        <script src="lib/osc/dist/osc-browser.min.js"></script>
        <script src="lib/flocking/dist/flocking-all.js"></script>
        <script src="lib/artlib/adam.js"></script>
        <!--script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.5.16/p5.js"></script-->

        <script>
            flock.init({
                chans:4, 
                bufferSize: 256
            });
            var as = flock.environment.audioSystem;
        </script>
        <style>
            body{
                padding: 0;
                margin: 0;
            }
            #meter{
                position: fixed;
                bottom: 0;
                left: 0;
            }
        </style>
    </head>
    <body>
        <script>
        var livetouches = {}; // put all touches in here

        var oscPort = new osc.WebSocketPort({
            url: "ws://localhost:8080", 
            metadata: true
        });

        oscPort.open();
        oscPort.on("bundle", function(bundle){
            //console.log(bundle);
            for (var i = 0; i < bundle.packets.length; i++){
                    // move this to array to DOM
                    //TUIOsetMessageToHTML(bundle.packets[i]);
                   
                TUIOmessagesToObject( bundle.packets[i] ); 
                //console.log(livetouches);
                TUIOaliveToObject( bundle.packets[i] );
                //arraytomapping(livetouches);
                        //touchArraytoDOM( livetouches );

                        /*
                        if (bundle.packets[i].args[0].value === "alive"){
                            //console.log(bundle.packets[i]);
                            var livemessages = document.getElementById("osctarget");
                            for (var l = 0; l < livemessages.children.length; l++){
                                var foundit = false;
                                for(var j = 1; j< bundle.packets[i].args.length; j++){
                                    if(livemessages.children[l].id === bundle.packets[i].args[j].value.toString()){
                                        foundit = true;
                                        break;
                                    }
                                } 
                                if (!foundit){
                                    livemessages.children[l].remove(); 
                                }
                            }
                        } */
            }

                    /*
                    // bad way to do this...
                    var livemessages = document.getElementById("osctarget");
                    for( var i = 0; i < livemessages.children.length; i++){
                        var superdata = JSON.parse (livemessages.children[i].innerHTML );
                        // range of 0.01 to 0.2 is pretty great
                        if (i === 0){
                            mintsynth.set("granny.grainDur", superdata.args[2].value / 5 + 0.01);
                        }
                        mintsynth.set("thing" + (i+1) + ".freq", superdata.args[3].value * 300 + 1);
                        mintsynth.set("thing" + (i+1) + ".mul", 0.4);
                    }
                    if(livemessages.children.length < 5){
                        for (var j = livemessages.children.length; j < 5; j++){
                            mintsynth.set("thing" + (j+1) + ".mul", 0);
                        }
                    }
                    */

        });

            oscPort.on("message", function(msg){
                //console.log(msg);
                TUIOmessagesToObject( msg ); 
                TUIOaliveToObject( msg );
                //arraytomapping(livetouches);
                //touchArraytoDOM( livetouches );
            });

            //////// SUPER BROKEN
            function touchArraytoDOM(touches){
                //document.getElementById("osctarget").removeChildren();
                //console.log( "print to dom" );

                const oscnode = document.getElementById("osctarget");
                while (oscnode.lastChild) {
                      oscnode.removeChild(oscnode.lastChild);
                }


                for(var i = 0; i < touches.length; i++){

                    console.log(touches.length);

                    var newaddress = document.createElement("div");
                    newaddress.id = touches[i]; 
                    var recenttouch = oscnode.firstChild;
                    oscnode.insertbefore(newaddress, recenttouch);
                } 
            };


            function TUIOsetMessageToHTML(packet){
                if (packet.address === "/tuio/2Dcur"){
                    if (packet.args[0].value === "set"){
                        var touchdiv =  document.getElementById( packet.args[1].value );
                        if(touchdiv === null){
                            var newaddress = document.createElement("div");
                            newaddress.id = packet.args[1].value;
                            newaddress.innerHTML = fluid.prettyPrintJSON(packet);
                            var recenttouch = document.getElementById("osctarget").firstChild;
                            document.getElementById("osctarget").insertBefore(newaddress, recenttouch);
                        } else{
                           touchdiv.innerHTML = fluid.prettyPrintJSON(packet);
                        }
                    }
                }
            };

            ///// super broken
            function arraytomapping(touches){
                /*
            
                    for( var i = 0; i < touches.length; i++){
                        // range of 0.01 to 0.2 is pretty great
                        if (i === 0){
                            mintsynth.set("granny.grainDur", superdata.args[2].value / 5 + 0.01);
                        }
                        mintsynth.set("thing" + (i+1) + ".freq", superdata.args[3].value * 300 + 1);
                        mintsynth.set("thing" + (i+1) + ".mul", 0.4);
                    }
                    if(livemessages.children.length < 5){
                        for (var j = livemessages.children.length; j < 5; j++){
                            mintsynth.set("thing" + (j+1) + ".mul", 0);
                        }
                    }

                */ 
            };

            function TUIOmessagesToObject(packet){
                if (packet.address === "/tuio/2Dcur"){
                    //console.log( typeof packet.args[0].value );
                    //console.log(packet);
                    if (packet.args[0].value === "set"){
                        //console.log(packet);
                        livetouches[ packet.args[1].value ] = [ packet.args[2].value, packet.args[3].value ];
                    }
                }
            };

            //broken?
            function TUIOaliveToObject(packet){
                if (packet.address === "/tuio/2Dcur"){
                    if(packet.args[0].value === "alive"){
                        var packetargs = packet.args;
                        packetargs.shift(); // remove first element which is the alive message
                        console.log(packetargs.length);
                        if(packetargs.length === 0){
                            livetouches = {};
                            return;
                        }
                        /*
                        var packetargsvalues = []; // create an array of strings of touch indices
                        for( var i = 0; i < packetargs.length; i++){
                            packetargsvalues[i] = packetargs[i].value;
                        }
                        console.log(packetargsvalues);

                        var livetouchesarray = Object.keys(livetouches);
                        console.log(livetouchesarray);
                        for(var i = 0; i < livetouchesarray.length; i++){
                            if( packetargsvalues.includes(livetouchesarray[i]) ){
                                console.log("found it");
                            }else{
                                console.log("not found " + packet.arg[i].value);
                                livemessages[ livetouchesarray[i] ] = undefined;

                            }
                        }                 
                        */


                        //for( var i = 0; i < Object.keys(livetouches).length; i++){
                        Object.keys(livetouches).forEach(function(key, i){
                            for (var j = 0; j < packetargs.length; j++){
                                if( parseInt(key)  === packetargs[j].value ){
                                    console.log("foundit");
                                    break;
                                }
                                console.log("not found" + key);
                                delete livetouches[key];
                            } 
                        });
                    }
                } 
            };

        </script>
        <script>
            var mintsynth = flock.synth({
                synthDef:{
                    ugen: "flock.ugen.freeverb",
                    mix: 1, 
                    damp: 0.7,
                    room: 0.9,
                    mul: 4,
                    source: {
                        ugen: "flock.ugen.granulator",
                        id: "granny",
                        numGrains: 20,
                        grainDur: 0.01,
                        delay: 8,
                        source: {
                            ugen: "flock.ugen.sum",
                            sources:[
                                {
                                   id: "thing1",
                                   ugen: "flock.ugen.saw", 
                                   freq: 300,
                                   mul: 0
                                },
                                {
                                   id: "thing2",
                                   ugen: "flock.ugen.saw", 
                                   freq: 300,
                                   mul: 0.0
                                },
                                {
                                   id: "thing3",
                                   ugen: "flock.ugen.saw", 
                                   freq: 300,
                                   mul: 0.0
                                },
                                {
                                   id: "thing4",
                                   ugen: "flock.ugen.saw", 
                                   freq: 300,
                                   mul: 0.0
                                },
                                {
                                   id: "thing5",
                                   ugen: "flock.ugen.saw", 
                                   freq: 300,
                                   mul: 0.0
                                }
                            ],
                        }
                    }
                } 
            });

            var basssynth = flock.synth({
                synthDef: {
                    ugen: "flock.ugen.distortion.tarrabiaDeJong",
                    amount: {
                        ugen: "flock.ugen.sin",
                        rate: "control",
                        id: "thing",
                        freq: 0.1 /// change this value!
                    },
                    source: {
                        ugen: "flock.ugen.saw",
                        freq: {
                            ugen: "flock.ugen.square",
                            mul: {
                                ugen: "flock.ugen.sin",
                                mul: 30,
                                freq: 2
                            },
                            add: 100
                        }
                    }
                }
            });
            basssynth.pause();

        </script>

        <input type="checkbox" id="sf1" name="sf1"><span id="sf1-label"></span>
        <input type="range" min="1" max="100" value="50" class="slider" id="myRange">
        <input type="checkbox" id="sf2" name="sf2"><span id="sf2-label"></span>
        <input type="range" min="1" max="100" value="50" class="slider" id="myRange2">
        <input type="checkbox" id="sf3" name="sf3"><span id="sf3-label"></span>
        <input type="range" min="1" max="100" value="50" class="slider" id="myRange3">
        <input type="checkbox" id="sf4" name="sf4"><span id="sf4-label"></span>
        <input type="range" min="1" max="100" value="50" class="slider" id="myRange4">
        <script>
            document.getElementById('sf1').onclick = function(){
                if(this.checked){
                    basssynth.play()
                }else{
                    basssynth.pause()
                }
            };
       
            document.getElementById('myRange').onchange = function(){
                basssynth.set("thing.freq", this.value/10);
                //console.log(basssynth.get("thing.freq"));
            }
        
        </script>

        <hr>

        <input type="checkbox" id="starter" name="starter"><span >start audio</span>
        <script>
            document.getElementById('starter').onclick= function(){
                if (this.checked){
                    flock.webAudio.audioSystem.audioContextSingleton.resume();
                }else{
                    //flock.enviro.shared.stop();
                }
            };
        </script>

        <h2>OSC</h2>
        <div id="osctarget"></div>

        <script> 
            flock.enviro.shared.play();
        </script>
    </body>
</html>
