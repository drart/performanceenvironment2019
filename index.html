<html>
    <head>
        <script src="lib/osc/dist/osc-browser.min.js"></script>
        <script src="lib/flocking/dist/flocking-all.js"></script>
        <!--script src="lib/artlib/adam.js"></script-->
        <!--script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.5.16/p5.js"></script-->

        <script>
            flock.init({
                //chans:4, 
                bufferSize: 256
            });
            var as = flock.environment.audioSystem;
        </script>
        <style>
            body{
                padding: 0;
                margin: 0;
            }
            #meter{
                box-sizing: border-box; 
                position: fixed;
                bottom: 0;
                left: 0;
                border: 3px solid grey;
                border-radius: 15px;
                width: 100%; //fallback
                width: 100vw;
                height: 75px;
            }
        </style>
    </head>
    <!-- prevent the contextual menu on right click-->
    <body oncontextmenu="return false;">
        <script>
        var livetouches = {}; // put all touches in here

        var oscPort = new osc.WebSocketPort({
            url: "ws://localhost:8080", 
            metadata: true
        });
        oscPort.open();

        oscPort.on("bundle", function(bundle){
            for (var i = 0; i < bundle.packets.length; i++){
                TUIOmessagesToObject( bundle.packets[i] ); 
                TUIOaliveToObject( bundle.packets[i] );
            }
            arraytomapping( livetouches );
            touchArraytoDOM( livetouches );
        });

        oscPort.on("message", function(msg){
            TUIOmessagesToObject( msg ); 
            TUIOaliveToObject( msg );
            arraytomapping( livetouches );
            touchArraytoDOM( livetouches );
        });

        function touchArraytoDOM(touches){
            var oscnode = document.getElementById("osctarget");
            // clear divs, not the cleanest way to do this...
            while (oscnode.lastChild) {
                  oscnode.removeChild(oscnode.lastChild);
            };
            Object.keys(touches).forEach(function(key, i){
                var newaddress = document.createElement("div");
                newaddress.id = key;
                newaddress.innerHTML= fluid.prettyPrintJSON(touches[key]);
                oscnode.appendChild(newaddress);
            }); 
        };

        function arraytomapping(touches){
            if ( basssynthplaying ){ 
                Object.keys(touches).forEach(function(key, i){
                    basssynth.set("thing.freq", touches[key][0]*10 + 0.01);
                    basssynth.set("thing.mul", touches[key][1]);
                    basssynth.set("mod.add", touches[key][1]*10 + 90);
                    mintsynth.set("thing" + (i+1) + ".mul", 0);
                });
                return;
            };

            if( gransynthplaying ){
                Object.keys(touches).forEach(function(key, i){
                    gransynth.set("granny.numGrains", touches[key][0]*50 );
                    gransynth.set("granny.grainDur", touches[key][1] + 0.01);
                    mintsynth.set("thing" + (i+1) + ".mul", 0);
                    //console.log(touches[key]);
                });
                return; 
            };

            Object.keys(touches).forEach(function(key, i){
                // range of 0.01 to 0.2 is pretty great
                if (i === 0){
                    mintsynth.set("granny.grainDur", touches[key][0] / 5 + 0.01);
                }
                mintsynth.set("thing" + (i+1) + ".freq", touches[key][1] * 300 + 1);
                mintsynth.set("thing" + (i+1) + ".mul", 0.4);
            });
            if (Object.keys(touches).length < 5){
                for (var j = Object.keys(touches).length; j < 5; j++){
                    if (j < 5){
                        mintsynth.set("thing" + (j+1) + ".mul", 0);
                    }
                };
            }
        };

        function TUIOmessagesToObject(packet){
            if (packet.address === "/tuio/2Dcur"){
                if (packet.args[0].value === "set"){
                    livetouches[ packet.args[1].value ] = [ packet.args[2].value, packet.args[3].value ];
                }
            }
        };
        
        function TUIOaliveToObject(packet){
            if (packet.address === "/tuio/2Dcur"){
                if(packet.args[0].value === "alive"){
                    var packetargs = packet.args;
                    packetargs.shift(); // remove first element which is the alive message
                    // if no touches are active then clear the toucharray
                    if(packetargs.length === 0){
                        livetouches = {};
                        return;
                    }
                    // search all keys for current session id, if not found then delete it
                    Object.keys(livetouches).forEach(function(key, i){
                        for (var j = 0; j < packetargs.length; j++){
                            if( parseInt(key)  === packetargs[j].value ){
                                return;
                            }
                        } 
                        delete livetouches[key];
                    });
                }
            } 
        };

        </script>
        <script>

            var gransynthplaying = false;
            var basssynthplaying = false;

            //https://stackoverflow.com/questions/36011249/detect-hold-mouse-click-in-javascript
            window.addEventListener('mousedown', function(e) {
                //console.log(e.button);
                mouseIsDown = true;
                if (e.button === 2){
                    setTimeout(function() {
                        if(mouseIsDown) {
                            // mouse was held down for > 2 seconds
                            if(basssynthplaying){
                                basssynth.noteOff();
                            }else{
                                basssynth.noteOn();
                            }
                            basssynthplaying = !basssynthplaying;
                        }
                    }, 2000);
                }else{
                    setTimeout(function() {
                        if(mouseIsDown) {
                            // mouse was held down for > 2 seconds
                            if(gransynthplaying){
                                gransynth.noteOff();
                            }else{
                                gransynth.noteOn();
                            }
                            gransynthplaying = !gransynthplaying;
                        }
                    }, 2000);
                }
            });

            window.addEventListener('mouseup', function() {
                  mouseIsDown = false;
            });

            // nice implementation to add an event after scrolling stops
            // https://stackoverflow.com/a/37951069/1945902
            var _scrollTimeout = null;
            var wheeldata = [0,0,0];

            function wheeldataaccumulator(e){
                wheeldata[0] += e.deltaX;
                wheeldata[1] += e.deltaY;
                wheeldata[2] += e.deltaZ;

                wheeldata[0] = Math.min( 1000, Math.max(wheeldata[0], 0)); 
                wheeldata[1] = Math.min( 1000, Math.max(wheeldata[1], 0)); 
                wheeldata[2] = Math.min( 1000, Math.max(wheeldata[2], 0)); 
            };

            window.addEventListener('wheel', function(e){
                var wheelnode = document.getElementById("wheeltarget");
                //wheeldata = [e.deltaX, e.deltaY, e.deltaZ]
                wheeldataaccumulator(e);
                wheelnode.innerHTML = fluid.prettyPrintJSON( wheeldata );

                clearTimeout(_scrollTimeout);
                _scrollTimeout = setTimeout(function() {
                    wheelnode.innerHTML = '';
                }, 250);
            });
        </script>

        <!--input type="checkbox" id="sf1" name="sf1"><span id="sf1-label"></span>
        <input type="range" min="1" max="100" value="50" class="slider" id="myRange">
        <input type="checkbox" id="sf2" name="sf2"><span id="sf2-label"></span>
        <input type="range" min="1" max="100" value="50" class="slider" id="myRange2">
        <input type="checkbox" id="sf3" name="sf3"><span id="sf3-label"></span>
        <input type="range" min="1" max="100" value="50" class="slider" id="myRange3">
        <input type="checkbox" id="sf4" name="sf4"><span id="sf4-label"></span>
        <input type="range" min="1" max="100" value="50" class="slider" id="myRange4"-->

        <input type="checkbox" id="starter" name="starter"><span >start audio</span>
        <script>
            document.getElementById('starter').onclick= function(){
                if (this.checked){
                    flock.webAudio.audioSystem.audioContextSingleton.resume();
                }else{
                    flock.enviro.shared.stop();
                }
            };
        </script>

        <h2>ScrollWheel</h2>
        <div id="wheeltarget"></div>
        <h2>OSC</h2>
        <div id="osctarget"></div>
        <canvas id="meter"></canvas>

        <script>
            var mintsynth = flock.synth({
                synthDef:{
                    ugen: "flock.ugen.scope",
                    source: {
                        ugen: "flock.ugen.freeverb",
                        mix: 1, 
                        damp: 0.7,
                        room: 0.9,
                        mul: 5,
                        source: {
                            ugen: "flock.ugen.granulator",
                            id: "granny",
                            numGrains: 20,
                            grainDur: 0.01,
                            delay: 8,
                            source: {
                                ugen: "flock.ugen.sum",
                                sources:[
                                {
                                    id: "thing1",
                                    ugen: "flock.ugen.saw", 
                                    freq: 300,
                                    mul: 0
                                },
                                {
                                    id: "thing2",
                                    ugen: "flock.ugen.saw", 
                                    freq: 300,
                                    mul: 0.0
                                },
                                {
                                    id: "thing3",
                                    ugen: "flock.ugen.saw", 
                                    freq: 300,
                                    mul: 0.0
                                },
                                {
                                    id: "thing4",
                                    ugen: "flock.ugen.saw", 
                                    freq: 300,
                                    mul: 0.0
                                },
                                {
                                    id: "thing5",
                                    ugen: "flock.ugen.saw", 
                                    freq: 300,
                                    mul: 0.0
                                }
                                ],
                            }
                        }
                    },
                    options: {
                        canvas: "#meter",
                        styles: {
                            strokeColor: "#777777",
                            strokeWidth: 2
                        }
                    }
                } 
            });

            var basssynth = flock.synth({
                synthDef: {
                    ugen: "flock.ugen.distortion.tarrabiaDeJong",
                    mul: {
                        ugen: "flock.ugen.asr",
                        attack: 10,
                        release: 5,
                        id: "env",
                        gate: 0,
                    },
                    amount: {
                        ugen: "flock.ugen.sin",
                        rate: "control",
                        id: "thing",
                        mul: 1,
                        freq: 0.1 /// change this value!

                    },
                    source: {
                        ugen: "flock.ugen.saw",
                        freq: {
                            id: "mod",
                            ugen: "flock.ugen.square",
                            mul: {
                                ugen: "flock.ugen.sin",
                                mul: 30,
                                freq: 2
                            },
                            add: 100
                        }
                    }
                }
            });

            var gransynth = flock.synth({
                synthDef: {
                    ugen: "flock.ugen.granulator",
                    id: "granny",
                    /*numGrains: {
                        ugen: "flock.ugen.line",
                        start: 1,
                        end: 50,
                        duration: 90
                    },
                    grainDur: {
                        ugen: "flock.ugen.line",
                        start: 0.1,
                        end: 0.005,
                        duration: 100
                    },*/
                    delayDur: 4,
                    mul: {
                        ugen: "flock.ugen.asr",
                        id: "env",
                        release: 5,
                        gate: 0,
                    },
                    source: {
                        ugen: "flock.ugen.playBuffer",
                        buffer: {
                            id: "chord",
                            url: "snd/C9drone.wav"
                        },
                        loop: 1,
                        start: 0,

                        end: 0.1
                    }
                }
            });

        </script>

        <script> 
            flock.enviro.shared.play();
        </script>
    </body>
</html>
